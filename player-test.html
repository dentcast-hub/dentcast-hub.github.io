<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>DentCast Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- فونت وزیرمتن -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --blue: #0b5fff;
      --blue-soft: #1b3b8f;
      --bg: #020617;
      --bg2: #020b1f;
      --card: #071c3b;
      --card2: #0b2146;
      --text-main: #e7eaf1;
      --text-sub: #9aa1b3;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: radial-gradient(circle at top, #082f49, #020617 60%);
      font-family: "Vazirmatn", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text-main);
      padding: 24px 8px;
      box-sizing: border-box;
    }

    .dc-wrapper {
      width: 100%;
      max-width: 480px;
      background: linear-gradient(145deg, rgba(5,21,52,0.95), rgba(3,10,30,0.98));
      border-radius: 24px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.6);
      border: 1px solid rgba(11,95,255,0.4);
      overflow: hidden;
    }

    .dc-header {
      display: flex;
      padding: 16px;
      gap: 12px;
      background: radial-gradient(circle at top left, rgba(11,95,255,0.35), transparent 55%);
    }

    .dc-cover {
      width: 72px;
      height: 72px;
      border-radius: 16px;
      overflow: hidden;
      flex-shrink: 0;
      border: 1px solid rgba(255,255,255,0.16);
    }

    .dc-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .dc-head-text {
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-width: 0;
    }

    .dc-show-name {
      font-size: 13px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .dc-episode-title {
      font-size: 15px;
      font-weight: 600;
      line-height: 1.35;
      max-height: 2.7em;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }

    .dc-episode-desc {
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-sub);
      max-height: 150px;
      overflow-y: auto;
      display: none;
    }

    .dc-episode-desc::-webkit-scrollbar {
      width: 4px;
    }
    .dc-episode-desc::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,0.6);
      border-radius: 999px;
    }

    .dc-main-player {
      padding: 12px 16px 8px;
      border-top: 1px solid rgba(255,255,255,0.08);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(3,13,35,0.95), rgba(4,16,42,0.98));
    }

    .dc-controls-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .dc-play-btn {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: none;
      background: radial-gradient(circle at 30% 20%, #38bdf8, #0b5fff 55%, #1d4ed8 100%);
      box-shadow: 0 10px 25px rgba(37,99,235,0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      font-size: 22px;
    }

    .dc-jump-btn {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: radial-gradient(circle at top, #0b2146, #020617);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 13px;
      color: var(--text-sub);
    }

    .dc-speed-box {
      display: flex;
      align-items: center;
      gap: 4px;
      background: rgba(15,23,42,0.95);
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid rgba(148,163,184,0.5);
    }

    .dc-speed-btn {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: none;
      background: rgba(15,23,42,0.9);
      color: var(--text-sub);
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .dc-speed-slider {
      flex: 1;
      accent-color: var(--blue);
    }

    .dc-speed-label {
      font-size: 12px;
      min-width: 30px;
      text-align: center;
    }

    .dc-range {
      width: 100%;
      margin: 6px 0;
      accent-color: var(--blue);
    }

    .dc-time-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-sub);
    }

    .dc-sort-row {
      padding: 8px 14px 0;
      display: flex;
      justify-content: flex-start;
    }

    #dc-sort-btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      background: var(--blue);
      color: white;
      font-size: 12px;
      cursor: pointer;
    }

    .dc-list {
      max-height: 280px; /* حدوداً ۵ ردیف روی موبایل */
      overflow-y: auto;
      background: radial-gradient(circle at top, #020b1f, #020617 55%);
    }

    .dc-episode-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      font-size: 13px;
      border-bottom: 1px solid rgba(15,23,42,0.95);
      cursor: pointer;
      background: transparent;
      transition: background 0.15s ease;
    }

    .dc-episode-item:hover {
      background: linear-gradient(90deg, rgba(11,95,255,0.24), transparent);
    }

    .dc-episode-item.active {
      background: linear-gradient(90deg, rgba(11,95,255,0.35), rgba(15,23,42,0.9));
    }

    .dc-ep-title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-left: 8px;
    }

    .dc-ep-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-sub);
    }

    .dc-ep-dot {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: rgba(148,163,184,0.8);
    }

    .dc-footer {
      padding: 6px 12px 10px;
      font-size: 11px;
      color: rgba(148,163,184,0.85);
      text-align: left;
    }

    .dc-footer a {
      color: #60a5fa;
      text-decoration: none;
      font-weight: 500;
    }

    /* اسکرول‌بار لیست اپیزودها */
    .dc-list::-webkit-scrollbar {
      width: 6px;
    }
    .dc-list::-webkit-scrollbar-track {
      background: transparent;
    }
    .dc-list::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,0.5);
      border-radius: 999px;
    }
  </style>
</head>
<body>

<div class="dc-wrapper">
  <!-- هدر بالا -->
  <div class="dc-header">
    <div class="dc-cover">
      <!-- اگر در JSON فیلد image داشتی می‌تونیم از اون بخونیم؛ فعلاً این کاور پیش‌فرضه -->
      <img id="dc-cover-img" src="https://assets.pippa.io/shows/624b5545ecc0e600134ea0df/show-cover.jpg" alt="DentCast cover">
    </div>
    <div class="dc-head-text">
      <div class="dc-show-name">Dentcast</div>
      <div class="dc-episode-title" id="dc-current-title">
        در حال بارگذاری اپیزودها...
      </div>
      <div class="dc-episode-desc" id="dc-current-desc"></div>
    </div>
  </div>

  <!-- پلیر اصلی -->
  <div class="dc-main-player">
    <audio id="dc-audio"></audio>

    <div class="dc-controls-row">
      <button class="dc-jump-btn" id="dc-back">⟲ 15s</button>

      <button class="dc-play-btn" id="dc-play">▶</button>

      <button class="dc-jump-btn" id="dc-forward">15s ⟳</button>

      <!-- باکس سرعت -->
      <div class="dc-speed-box">
        <button class="dc-speed-btn" id="dc-speed-minus">−</button>
        <input type="range" min="0.75" max="2" step="0.25" value="1"
               class="dc-speed-slider" id="dc-speed-slider">
        <div class="dc-speed-label" id="dc-speed-label">1x</div>
        <button class="dc-speed-btn" id="dc-speed-plus">+</button>
      </div>
    </div>

    <input type="range" min="0" max="100" value="0" class="dc-range" id="dc-seek">

    <div class="dc-time-row">
      <span id="dc-time-current">00:00</span>
      <span id="dc-time-duration">00:00</span>
    </div>
  </div>

  <!-- مرتب‌سازی -->
  <div class="dc-sort-row">
    <button id="dc-sort-btn">مرتب‌سازی: جدید → قدیم</button>
  </div>

  <!-- لیست اپیزودها -->
  <div class="dc-list" id="dc-list"></div>

  <div class="dc-footer">
    داده‌ها از فایل <code>dentcast.json</code> در روت سایت لود می‌شوند.
  </div>
</div>

<script>
  // به‌جای RSS از فایل dentcast.json در روت
  const JSON_URL = "dentcast.json";

  const audio        = document.getElementById("dc-audio");
  const playBtn      = document.getElementById("dc-play");
  const backBtn      = document.getElementById("dc-back");
  const fwdBtn       = document.getElementById("dc-forward");
  const seek         = document.getElementById("dc-seek");
  const tCur         = document.getElementById("dc-time-current");
  const tDur         = document.getElementById("dc-time-duration");
  const listEl       = document.getElementById("dc-list");
  const currentTitleEl = document.getElementById("dc-current-title");
  const currentDescEl  = document.getElementById("dc-current-desc");
  const coverImg     = document.getElementById("dc-cover-img");
  const sortBtn      = document.getElementById("dc-sort-btn");

  const speedSlider  = document.getElementById("dc-speed-slider");
  const speedLabel   = document.getElementById("dc-speed-label");
  const speedMinus   = document.getElementById("dc-speed-minus");
  const speedPlus    = document.getElementById("dc-speed-plus");

  let episodesRaw = [];
  let episodes    = [];
  let currentIndex = 0;
  let isSeeking    = false;
  let sortDescending = true; // جدید → قدیم
  let descVisible    = false;

  function formatTime(sec) {
    if (!sec || !isFinite(sec)) return "00:00";
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
  }

  function setSpeed(val) {
    const v = Math.min(2, Math.max(0.75, parseFloat(val)));
    audio.playbackRate = v;
    speedSlider.value = v;
    speedLabel.textContent = v.toFixed(2).replace(/\.00$/, "") + "x";
  }

  // کنترل پخش
  playBtn.addEventListener("click", () => {
    if (!audio.src) return;
    if (audio.paused) audio.play();
    else audio.pause();
  });

  audio.addEventListener("play", () => {
    playBtn.textContent = "⏸";
  });

  audio.addEventListener("pause", () => {
    playBtn.textContent = "▶";
  });

  backBtn.addEventListener("click", () => {
    if (!audio.duration) return;
    audio.currentTime = Math.max(0, audio.currentTime - 15);
  });

  fwdBtn.addEventListener("click", () => {
    if (!audio.duration) return;
    audio.currentTime = Math.min(audio.duration, audio.currentTime + 15);
  });

  speedSlider.addEventListener("input", () => setSpeed(speedSlider.value));
  speedMinus.addEventListener("click", () => setSpeed(parseFloat(speedSlider.value) - 0.25));
  speedPlus.addEventListener("click", () => setSpeed(parseFloat(speedSlider.value) + 0.25));

  seek.addEventListener("input", () => {
    if (!audio.duration) return;
    isSeeking = true;
    const pct = parseFloat(seek.value) / 100;
    audio.currentTime = pct * audio.duration;
  });

  seek.addEventListener("change", () => { isSeeking = false; });

  audio.addEventListener("loadedmetadata", () => {
    tDur.textContent = formatTime(audio.duration);
  });

  audio.addEventListener("timeupdate", () => {
    tCur.textContent = formatTime(audio.currentTime);
    if (!isSeeking && audio.duration) {
      seek.value = (audio.currentTime / audio.duration) * 100;
    }
  });

  audio.addEventListener("ended", () => {
    if (currentIndex < episodes.length - 1) {
      loadEpisode(currentIndex + 1);
      audio.play();
    }
  });

  // باز/بسته کردن توضیح زیر عنوان
  currentTitleEl.addEventListener("click", () => {
    descVisible = !descVisible;
    currentDescEl.style.display = descVisible ? "block" : "none";
  });

  function loadEpisode(index) {
    const ep = episodes[index];
    if (!ep) return;
    currentIndex = index;

    audio.src = ep.audio_url;
    currentTitleEl.textContent = ep.title;
    currentDescEl.innerHTML = ep.description || "";
    descVisible = false;
    currentDescEl.style.display = "none";

    // اگر بعدها تو dentcast.json فیلد image اضافه کردی:
    // const img = ep.image || coverImg.src;
    // coverImg.src = img;
    // فعلاً همون کاور پیش‌فرض می‌مونه.

    Array.from(listEl.children).forEach((el, i) => {
      el.classList.toggle("active", i === index);
    });

    tCur.textContent = "00:00";
    tDur.textContent = "00:00";
    seek.value = 0;
  }

  function createEpisodeRow(ep, index) {
    const row = document.createElement("div");
    row.className = "dc-episode-item";

    const left = document.createElement("div");
    left.className = "dc-ep-title";
    left.textContent = ep.title;

    const right = document.createElement("div");
    right.className = "dc-ep-meta";

    const durSpan = document.createElement("span");
    durSpan.textContent = ep.duration || "";

    const dot = document.createElement("span");
    dot.className = "dc-ep-dot";

    const numSpan = document.createElement("span");
    numSpan.textContent = ep.episode ? `#${ep.episode}` : "";

    right.appendChild(durSpan);
    right.appendChild(dot);
    right.appendChild(numSpan);

    row.appendChild(left);
    row.appendChild(right);

    row.addEventListener("click", () => {
      loadEpisode(index);
      audio.play();
    });

    return row;
  }

  function renderList() {
    listEl.innerHTML = "";
    episodes.forEach((ep, i) => {
      const row = createEpisodeRow(ep, i);
      listEl.appendChild(row);
    });
  }

  function applySorting() {
    episodes = [...episodesRaw].sort((a, b) => {
      const A = parseFloat(a.episode);
      const B = parseFloat(b.episode);
      if (isNaN(A) || isNaN(B)) return 0;
      return sortDescending ? B - A : A - B;
    });
    renderList();
  }

  sortBtn.addEventListener("click", () => {
    sortDescending = !sortDescending;
    sortBtn.textContent = sortDescending
      ? "مرتب‌سازی: جدید → قدیم"
      : "مرتب‌سازی: قدیم → جدید";
    applySorting();
    if (episodes.length) loadEpisode(0);
  });

  // لود از dentcast.json
  fetch(JSON_URL)
    .then(res => res.json())
    .then(data => {
      episodesRaw = data;
      applySorting();
      if (episodes.length > 0) {
        loadEpisode(0);
      } else {
        currentTitleEl.textContent = "اپیزودی در فایل dentcast.json پیدا نشد.";
      }
    })
    .catch(err => {
      console.error("JSON error:", err);
      currentTitleEl.textContent = "خطا در لود فایل dentcast.json.";
    });

  // سرعت پیش‌فرض
  setSpeed(1);
</script>

</body>
</html>
